<!DOCTYPE HTML>
<!--
        Miracle: A Sega Master System emulator in JavaScript.

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
	
	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.

	By Matt Godbolt: <matt@godbolt.org>

	Z80 support from JSSpeccy:	
	Contact details: <matthew@west.co.tt>
	Matthew Westcott, 14 Daisy Hill Drive, Adlington, Chorley, Lancs PR6 9NE UNITED KINGDOM
-->
<html>
	<head>
		<title>Miracle</title>
		<link rel="stylesheet" href="miracle.css" type="text/css">
		<script type="text/javascript" src="z80/z80_full.js"></script>
		<script type="text/javascript" src="z80/z80_ops_full.js"></script>
		<script type="text/javascript" src="z80/z80_dis.js"></script>
		<script type="text/javascript" src="vdp.js"></script>
		<script type="text/javascript" src="miracle.js"></script>
		<script type="text/javascript" src="roms.js"></script>
		<script type="text/javascript">/* <![CDATA[ */
			var tstates = 0;
			var running;
			var event_next_event;
			function addRomToList(rom) {
				var li = document.createElement('li');
				var a = document.createElement('a');
				a.appendChild(document.createTextNode(rom));
				li.appendChild(a);
				a.href = 'javascript:void(0)';
				a.onclick = function() {
					loadRom(roms[rom]);
					hideRomChooser();
					start();
				}
				document.getElementById('rom_list').appendChild(li);
			}
			function go() {
				hideRomChooser();
				hideAbout();
				for (rom in roms) {
					addRomToList(rom);
				}
				var disass = document.getElementById('disassembly');
				for (var i = 1; i < 16; i++) {
					disass.appendChild(disass.children[0].cloneNode(true));
				}
				z80_init();
				miracle_init();
				loadRom(roms['SonicTheHedgehog.sms']);
				start();
			}
			function frame() {
				var vdp_status = 0;
				while ((vdp_status & 2) == 0) {
					event_next_event = 220; // TASK: not 220?
					tstates -= 220;
					z80_do_opcodes();
					vdp_status = vdp_hblank();
					if (vdp_status) {
						z80_interrupt();
					}
				}
				paintScreen();
			}
			function updateDebug() {
				var disass = document.getElementById('disassembly');
				var pc = z80.pc;
				for (var i = 0; i < disass.childElementCount; ++i) {
					var result = disassemble(pc);
					var child = disass.children[i];
					child.getElementsByClassName('addr')[0].textContent = '0x' + hexword(pc);
					child.getElementsByClassName('disassembly')[0].textContent = result[0];
					pc = result[1];
				}
				for (var reg in z80) {
					var elem = document.getElementById('z80_' + reg);
					if (elem) {
						if (reg.length > 1) {
							elem.textContent = '0x' + hexword(z80[reg]);
						} else {
							elem.textContent = '0x' + hexbyte(z80[reg]);
						}
					}
				}
			}
			function step() {
				var curpc = z80.pc;
				for (var i = 0; i < 65536; i++) {
					tstates = 0;
					event_next_event = 1;
					z80_do_opcodes();
					if (z80.pc != curpc) break;
				}
				updateDebug();
			}
			function start() {
				updateDebug();
				if (running) return;
				running = true;
				document.getElementById('menu').className = 'running';
				run();
			}
			function run() {
				if (!running) {
					updateDebug();
					return;
				}
				setTimeout(run, 20);
				try {
					frame();
				} catch (e) {
					running = false;
					throw e;
				}
			}
			function stop() {
				document.getElementById('menu').className = 'stopped';
				running = false;
			}
			function reset() {
				z80_reset();
			}
			function showRomChooser() {
				document.getElementById('rom_chooser').style.display = 'block';
			}
			function hideRomChooser() {
				document.getElementById('rom_chooser').style.display = 'none';
			}
			function showAbout() {
				document.getElementById('about').style.display = 'block';
			}
			function hideAbout() {
				document.getElementById('about').style.display = 'none';
			}
		/* ]]> */</script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-55180-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

</script>
	</head>
	<body onload="go()">
		<canvas id="screen" width="256" height="192"></canvas>
		<div id="debug">
			<div id="disassembly">
				<div><span class="addr">0x0000</span> - <span class="disassembly">LD A,(HL)</span></div>
			</div>
			<div id="registers">
				<div>AF: <span id="z80_a">0x00</span>:<span id="z80_f">0x00</span></div>
				<div>BC: <span id="z80_b">0x00</span>:<span id="z80_c">0x00</span></div>
				<div>DE: <span id="z80_d">0x00</span>:<span id="z80_e">0x00</span></div>
				<div>HL: <span id="z80_h">0x00</span>:<span id="z80_l">0x00</span></div>
				<div>SP: <span id="z80_sp">0x0000</span></div>
				<div>PC: <span id="z80_pc">0x0000</span></div>
			</div>
		</div>
		<ul id="menu" class="stopped">
			<li id="menu_run"><a href="javascript:void(0)" onclick="start()" title="Play">Play</a></li>
			<li id="menu_stop"><a href="javascript:void(0)" onclick="stop()" title="Pause">Pause</a></li>
			<li id="menu_step"><a href="javascript:void(0)" onclick="step()" title="Step">Step</a></li>
			<li id="menu_reset"><a href="javascript:void(0)" onclick="reset()" title="Reset">Reset</a></li>
			<li id="menu_open"><a href="javascript:void(0)" onclick="showRomChooser()" title="Open ROM">Open ROM</a></li>
			<li id="menu_about"><a href="javascript:void(0)" onclick="showAbout()" title="About Miracle">About Miracle</a></li>
		</ul>
		<br />
		<div id="rom_chooser">
			<div>Open ROM file: <input type="file" id="file_upload" /></div>
			<p>Or select a game:</p>
			<ul id="rom_list"></ul>
			<a href="javascript:void(0)" class="close_button" onclick="hideRomChooser()">Close</a>
		</div>
		<div id="about">
			<h1>Miracle</h1>
			<h2>a Sega Master System emulator in Javascript</h2>
			<p>By <a href="http://xania.org/">Matt Godbolt</a></p>
			<p>Based on <a href="http://matt.west.co.tt/category/javascript/jsspeccy/">JSSpeccy</a> by <a href="http://matt.west.co.tt/">Matt Westcott</a></p>
			<p>..which in turn is based on <a href="http://fuse-emulator.sourceforge.net/">Fuse</a> by Philip Kendall et al. Icons from <a href="http://www.icon-king.com/projects/nuvola/">Nuvola</a> by David Vignoni.</p>
			<div id="licence">
				<p>This program is free software: you can redistribute it and/or modify
				it under the terms of the GNU General Public License as published by
				the Free Software Foundation, either version 3 of the License, or
				(at your option) any later version.</p>
				<p>This program is distributed in the hope that it will be useful,
				but WITHOUT ANY WARRANTY; without even the implied warranty of
				MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
				GNU General Public License for more details.</p>
				
				<p>You should have received a copy of the GNU General Public License
				along with this program.  If not, see &lt;<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</p>
			</div>

			<a href="javascript:void(0)" class="close_button" onclick="hideAbout()">Close</a>
		</div>
	</body>
</html>
